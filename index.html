<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
<title>Mobile RTA — v1 (FFT only, Log X)</title>
<!--
  ✅ Checkpoint v1 — 2025-08-11
  โฟกัส: เริ่มใหม่แบบมินิมอลให้เสถียรสุด ๆ ก่อน แล้วค่อยไต่ระดับฟีเจอร์
  มีแค่: Start/Stop + FFT แบบ Log scale + Smoothing + FFT size
  ไม่มี: Peak Hold, 1/3 Octave, Spectrogram (ไว้ v2/v3)
-->
<style>
  :root{ --bg:#0b1220; --card:#0f172a; --ink:#e5e7eb; --muted:#94a3b8; --line:#1f2937; --accent:#10b981; }
  html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);font-family:system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans Thai", sans-serif}
  .wrap{max-width:800px;margin:0 auto;padding:14px;display:flex;flex-direction:column;gap:12px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px}
  .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
  button{background:var(--accent);border:none;color:#fff;padding:10px 14px;border-radius:10px;font-weight:700}
  button.secondary{background:#334155}
  label{font-size:12px;color:var(--muted)}
  canvas{width:100%;height:320px;background:#0b1220;border-radius:12px;display:block}
  .hint{font-size:12px;color:var(--muted)}
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div>
          <h2 style="margin:0 0 4px 0">Mobile RTA — v1</h2>
          <div class="hint">เริ่มแบบเรียบง่าย: ใช้ไมค์มือถือ + FFT • แกน X เป็น Log (20–20k) • ต้องเปิดผ่าน HTTPS เท่านั้น</div>
        </div>
        <div class="row">
          <button id="btnStart">▶️ เริ่มวัด</button>
          <button id="btnStop" class="secondary" disabled>⏸️ หยุด</button>
        </div>
      </div>
      <div class="row" style="margin-top:6px">
        <label>FFT Size
          <select id="fft">
            <option>2048</option>
            <option selected>4096</option>
            <option>8192</option>
            <option>16384</option>
          </select>
        </label>
        <label> Smoothing <input id="smoothing" type="range" min="0" max="0.95" step="0.01" value="0.7"></label>
        <span class="hint" id="meta">—</span>
      </div>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:6px">
        <b>FFT (Log Frequency)</b>
        <span class="hint" id="sr">—</span>
      </div>
      <canvas id="fftCanvas" width="1200" height="340"></canvas>
    </div>

    <div class="card hint" id="errBox" style="display:none"></div>
  </div>

<script>
(() => {
  // ===== DOM =====
  const btnStart = document.getElementById('btnStart');
  const btnStop  = document.getElementById('btnStop');
  const fftSel   = document.getElementById('fft');
  const smoothing= document.getElementById('smoothing');
  const srLabel  = document.getElementById('sr');
  const meta     = document.getElementById('meta');
  const errBox   = document.getElementById('errBox');

  const canvas = document.getElementById('fftCanvas');
  const ctx = canvas.getContext('2d');

  // ===== Audio state =====
  let audioCtx, analyser, mic, dataTime, dataFreq, rafId;
  let running = false;
  let sampleRate = 48000;

  // ===== Helpers =====
  const clamp01 = v => Math.min(1, Math.max(0, v));
  const dbfs = v => 20*Math.log10(v/255 + 1e-12);
  const fMin = 20;
  function mapLogX(f, width){
    const fMax = Math.min(sampleRate/2, 20000);
    const t = (Math.log10(Math.max(f, fMin)) - Math.log10(fMin)) / (Math.log10(fMax) - Math.log10(fMin));
    return 40 + t * (width - 50);
  }

  function drawBackground(){
    const w = canvas.width, h = canvas.height;
    ctx.clearRect(0,0,w,h);
    // grid horiz
    ctx.strokeStyle = 'rgba(255,255,255,0.05)';
    for(let i=0;i<6;i++){
      const y = (h-20)*(i/5)+10; ctx.beginPath(); ctx.moveTo(40,y); ctx.lineTo(w-10,y); ctx.stroke();
    }
    // grid vert @ common log ticks
    const ticks = [20,31.5,40,50,63,80,100,125,160,200,250,315,400,500,630,800,1000,2000,4000,8000,16000];
    ctx.strokeStyle = 'rgba(255,255,255,0.05)';
    ticks.forEach(t=>{ const x = mapLogX(t,w); ctx.beginPath(); ctx.moveTo(x,10); ctx.lineTo(x,h-10); ctx.stroke(); });
    // frame
    ctx.strokeStyle = 'rgba(255,255,255,0.08)'; ctx.strokeRect(40,10,w-50,h-20);
    // labels
    ctx.fillStyle = 'rgba(255,255,255,0.65)'; ctx.font='12px system-ui';
    [31.5,63,125,250,500,1000,2000,4000,8000,16000].forEach(t=>{ const x=mapLogX(t,w); ctx.fillText(t>=1000? (t/1000)+'k':t, x-8, h-4); });
  }

  function drawSpectrum(){
    const w = canvas.width, h = canvas.height;
    drawBackground();
    if(!dataFreq) return;
    const N = dataFreq.length;
    const fpb = sampleRate / (2*N);
    ctx.beginPath(); let started=false;
    for(let i=1;i<N;i++){
      const f = i*fpb; if(f < fMin) continue; if(f>20000) break;
      const x = mapLogX(f,w);
      const y = 10 + (1 - clamp01((dbfs(dataFreq[i])+100)/100))*(h-20);
      if(!started){ ctx.moveTo(x,y); started=true; } else { ctx.lineTo(x,y); }
    }
    ctx.strokeStyle='#34d399'; ctx.lineWidth=2; ctx.stroke();
  }

  function loop(){
    if(!running) return;
    analyser.getByteTimeDomainData(dataTime);
    analyser.getByteFrequencyData(dataFreq);
    drawSpectrum();
    rafId = requestAnimationFrame(loop);
  }

  async function start(){
    try{
      btnStart.disabled = true; btnStop.disabled = false; errBox.style.display='none';
      const stream = await navigator.mediaDevices.getUserMedia({ audio:{ echoCancellation:false, noiseSuppression:false, autoGainControl:false } });
      audioCtx = new (window.AudioContext||window.webkitAudioContext)({latencyHint:'interactive'});
      if(audioCtx.state==='suspended') await audioCtx.resume();
      sampleRate = audioCtx.sampleRate; srLabel.textContent = sampleRate + ' Hz';

      analyser = audioCtx.createAnalyser();
      analyser.fftSize = parseInt(fftSel.value,10);
      analyser.smoothingTimeConstant = parseFloat(smoothing.value);

      mic = audioCtx.createMediaStreamSource(stream);
      mic.connect(analyser);

      dataTime = new Uint8Array(analyser.fftSize);
      dataFreq = new Uint8Array(analyser.frequencyBinCount);

      running = true; loop();
    }catch(err){
      btnStart.disabled=false; btnStop.disabled=true;
      errBox.style.display='block'; errBox.textContent = 'เปิดไมค์ไม่สำเร็จ: ' + (err.message||err);
    }
  }
  function stop(){
    running=false; if(rafId) cancelAnimationFrame(rafId);
    try{ mic && mic.disconnect(); }catch{}
    try{ analyser && analyser.disconnect(); }catch{}
    if(audioCtx){ audioCtx.close(); }
    btnStart.disabled=false; btnStop.disabled=true;
  }

  // ===== Events =====
  btnStart.addEventListener('click', start, {passive:true});
  btnStop.addEventListener('click', stop, {passive:true});
  fftSel.addEventListener('change', ()=>{ if(analyser){ analyser.fftSize = parseInt(fftSel.value,10); dataTime = new Uint8Array(analyser.fftSize); dataFreq = new Uint8Array(analyser.frequencyBinCount);} });
  smoothing.addEventListener('input', ()=>{ if(analyser){ analyser.smoothingTimeConstant = parseFloat(smoothing.value);} });

  // meta
  meta.textContent = 'iOS ต้องแตะปุ่มเพื่อเริ่ม AudioContext • ใช้งานผ่าน HTTPS เท่านั้น';
})();
</script>
</body>
</html>
